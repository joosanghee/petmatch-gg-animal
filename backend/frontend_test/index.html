<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PetMatch</title>
  <link rel="stylesheet" href="{{ url_for('serve_css') }}" />
  <style>
    /* í•˜íŠ¸ ë²„íŠ¼ í™œì„±í™” ìŠ¤íƒ€ì¼ */
    .btn.liked { color: red; border-color: red; background: #fff5f5; }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand"><a href="/" style="text-decoration:none; color:inherit;">ğŸ¾ PetMatch</a></div>
    <nav class="nav">
      <a href="/animals">ìœ ê¸°ë™ë¬¼</a>
      <a href="/shelter">ë³´í˜¸ì†Œ</a>
      <a href="/hospital">ë³‘ì›/ì•½êµ­</a>
      
      {% if session['user_id'] %}
        <span style="font-size:14px; font-weight:bold; margin-right:4px;">{{ session['user_name'] }}ë‹˜</span>
        
        {% if session.get('is_admin') == 1 %}
          <a class="btn primary" href="/admin" style="padding: 6px 12px; font-size: 13px;">ê´€ë¦¬ì</a>
        {% endif %}

        <a class="btn ghost" href="/logout">ë¡œê·¸ì•„ì›ƒ</a>
      {% else %}
        <a class="btn ghost" href="/login">ë¡œê·¸ì¸</a>
      {% endif %}
          </nav>
  </header>

  <main class="container">
    <section class="hero">
      <h1>ê°€ì¡±ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¹œêµ¬ë“¤ì„ ì°¾ì•„ìš”</h1>
      <p>ì§€ì—­/í’ˆì¢…/ì„±ë³„ë¡œ ë¹ ë¥´ê²Œ ê²€ìƒ‰í•˜ê³  ë³´í˜¸ì†Œ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
      
      <div class="searchbar">
        <input id="homeSearchInput" placeholder="í’ˆì¢…, ì§€ì—­, í‚¤ì›Œë“œë¡œ ê²€ìƒ‰" onkeypress="handleEnter(event)"/>
        <button class="btn primary" onclick="goSearch()">ê²€ìƒ‰</button>
      </div>
      
      <div class="chips">
        <button class="chip" onclick="goFilter('species', 'ê°œ')">ê°•ì•„ì§€</button>
        <button class="chip" onclick="goFilter('species', 'ê³ ì–‘ì´')">ê³ ì–‘ì´</button>
        <button class="chip" onclick="goFilter('gender', 'ìˆ˜ì»·')">ìˆ˜ì»·</button>
        <button class="chip" onclick="goFilter('gender', 'ì•”ì»·')">ì•”ì»·</button>
      </div>
    </section>

    <section class="results">
      <div class="results-head">
        <h2>ìµœì‹  ë“±ë¡ëœ ì¹œêµ¬ë“¤ ğŸ¾</h2>
        <a href="/animals" class="btn ghost">ë”ë³´ê¸°</a>
      </div>

      <div class="grid">
        {% if latest_animals %}
          {% for animal in latest_animals %}
          <article class="card">
            <div class="thumb" style="background-color: #eee; display:flex; align-items:center; justify-content:center; overflow:hidden;">
              {% if animal['image_url'] %}
                <img src="{{ animal['image_url'] }}" alt="{{ animal['breed'] }}" style="width:100%; height:100%; object-fit:cover;">
              {% else %}
                <span style="font-size:30px;">ğŸ¶</span>
              {% endif %}
            </div>
            <div class="card-body">
              <div class="title">{{ animal['breed'] }}</div>
              <div class="meta">{{ animal['gender'] }} Â· {{ animal['weight'] }}</div>
              <div class="meta">ì§€ì—­: {{ animal['region'] }}</div>
              <div class="meta">ê³µê³ : {{ animal['register_date'] }}</div>
              <div class="meta">ë³´í˜¸ì†Œ: {{ animal['shelter_name'] }}</div>
              <div class="actions">
                <a class="btn primary" href="/animals?keyword={{ animal['breed'] }}">ë³´ëŸ¬ê°€ê¸°</a>
                
                <button class="btn ghost {% if animal['animal_id'] in fav_ids %}liked{% endif %}" 
                        id="btn-fav-{{ animal['animal_id'] }}"
                        onclick="toggleFavorite({{ animal['animal_id'] }})">
                  {% if animal['animal_id'] in fav_ids %}â™¥{% else %}â™¡{% endif %}
                </button>
              </div>
            </div>
          </article>
          {% endfor %}
        {% else %}
          <p style="padding:20px;">ìµœì‹  ë“±ë¡ëœ ìœ ê¸°ë™ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endif %}
      </div>
    </section>
  </main>

  <script>
    // ì¢‹ì•„ìš” í† ê¸€ ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€
    async function toggleFavorite(animalId) {
        try {
            const response = await fetch(`/api/favorite/${animalId}`, { method: 'POST' });
            if (response.status === 401) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤!');
                window.location.href = '/login';
                return;
            }
            const data = await response.json();
            
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³€ê²½
            const btn = document.getElementById(`btn-fav-${animalId}`);
            if (data.action === 'added') {
                btn.classList.add('liked');
                btn.innerHTML = 'â™¥';
            } else {
                btn.classList.remove('liked');
                btn.innerHTML = 'â™¡';
            }
        } catch (error) {
            console.error('ì¢‹ì•„ìš” ì²˜ë¦¬ ì‹¤íŒ¨:', error);
        }
    }

    // ê¸°ì¡´ ê²€ìƒ‰/í•„í„° í•¨ìˆ˜ë“¤
    function goSearch() {
        const keyword = document.getElementById('homeSearchInput').value;
        if (keyword) {
            window.location.href = `/animals?keyword=${encodeURIComponent(keyword)}`;
        } else {
            alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        }
    }

    function goFilter(key, value) {
        window.location.href = `/animals?${key}=${encodeURIComponent(value)}`;
    }

    function handleEnter(e) {
        if(e.key === 'Enter') goSearch();
    }
  </script>
</body>
</html>