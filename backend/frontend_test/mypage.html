<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PetMatch - ë§ˆì´í˜ì´ì§€</title>
  <link rel="stylesheet" href="{{ url_for('serve_css') }}" />
</head>
<body>
  <header class="topbar">
    <div class="brand"><a href="/" style="text-decoration:none; color:inherit;">ğŸ¾ PetMatch</a></div>
    <nav class="nav">
      <a href="/animals">ìœ ê¸°ë™ë¬¼</a>
      <a href="/shelter">ë³´í˜¸ì†Œ</a>
      <a href="/hospital">ë³‘ì›/ì•½êµ­</a>
      <a class="btn ghost" href="/logout">ë¡œê·¸ì•„ì›ƒ</a>
    </nav>
  </header>

  <main class="container">
    <section class="hero" style="margin-bottom:20px;">
      <h1 style="margin-bottom:8px;">ì•ˆë…•í•˜ì„¸ìš”, {{ user_name }}ë‹˜! ğŸ‘‘</h1>
      <p style="margin-bottom:14px;">ë‚´ê°€ ê´€ì‹¬ìˆì–´í•œ ì¹œêµ¬ë“¤ì„ ëª¨ì•„ë´¤ì–´ìš”.</p>
    </section>

    <section class="results">
      <div class="results-head">
        <div>ì´ <b>{{ animals|length }}</b>ë§ˆë¦¬ë¥¼ ì°œí•˜ì…¨ë„¤ìš”.</div>
      </div>

      <div class="grid">
        {% if animals %}
          {% for animal in animals %}
          <article class="card">
            <div class="thumb" style="background-color: #eee; display:flex; align-items:center; justify-content:center; overflow:hidden;">
              {% if animal['image_url'] %}
                <img src="{{ animal['image_url'] }}" alt="{{ animal['breed'] }}" style="width:100%; height:100%; object-fit:cover;">
              {% else %}
                <span style="font-size:30px;">ğŸ•</span>
              {% endif %}
            </div>
            <div class="card-body">
              <div class="title">{{ animal['breed'] }}</div>
              <div class="meta">{{ animal['gender'] }} Â· {{ animal['weight'] }}</div>
              <div class="meta">ì§€ì—­: {{ animal['region'] }}</div>
              <div class="meta">ë³´í˜¸ì†Œ: {{ animal['shelter_name'] }}</div>
              <div class="actions">
                <button class="btn primary" onclick="openDetailModal({{ animal['animal_id'] }})">ìƒì„¸</button>
                
                <button class="btn ghost" style="color:red; border-color:red; background:#fff5f5;" 
                        onclick="removeFavorite({{ animal['animal_id'] }})">
                  â™¥ ì°œ ì·¨ì†Œ
                </button>
              </div>
            </div>
          </article>
          {% endfor %}
        {% else %}
          <div style="padding:40px; text-align:center; grid-column: 1 / -1; color:#666;">
            <p style="font-size:50px; margin-bottom:10px;">ğŸ•</p>
            <p>ì•„ì§ ì°œí•œ ë™ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.<br>ë§ˆìŒì— ë“œëŠ” ì¹œêµ¬ì—ê²Œ í•˜íŠ¸ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”! â¤ï¸</p>
            <a href="/animals" class="btn primary" style="margin-top:20px;">ì¹œêµ¬ë“¤ ë³´ëŸ¬ê°€ê¸°</a>
          </div>
        {% endif %}
      </div>
    </section>
  </main>

  <div id="animalModal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-window">
      <button class="modal-close" onclick="closeModalButton()">Ã—</button>
      <div class="modal-image-area">
          <img id="m_image" src="" alt="" />
          <span id="m_emoji" style="font-size:50px; display:none;">ğŸ•</span>
      </div>
      <div class="modal-content">
        <div class="modal-tag" id="m_status">ë³´í˜¸ì¤‘</div>
        <h2 id="m_breed"></h2>
        <div class="modal-info-row"><div class="modal-label">íŠ¹ì§•</div><div class="modal-value"><span id="m_gender"></span> / <span id="m_weight"></span></div></div>
        <div class="modal-info-row"><div class="modal-label">ë‚˜ì´</div><div class="modal-value" id="m_years"></div></div>
        <div class="modal-info-row"><div class="modal-label">ë°œê²¬ì¥ì†Œ</div><div class="modal-value" id="m_region"></div></div>
        <div class="modal-info-row"><div class="modal-label">ê³µê³ ê¸°ê°„</div><div class="modal-value"><span id="m_sdate"></span> ~ <span id="m_edate"></span></div></div>
        <hr style="border:0; border-top:1px dashed #ddd; margin:15px 0;">
        <div class="modal-info-row"><div class="modal-label">ë³´í˜¸ì†Œ</div><div class="modal-value" id="m_shelter"></div></div>
        <div class="actions" style="margin-top:20px;">
            <button class="btn primary full" onclick="contactShelter()">ğŸ“ ì…ì–‘ ë¬¸ì˜í•˜ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentShelterPhone = '';

    // 1. ì°œ ì‚­ì œ í•¨ìˆ˜
    async function removeFavorite(animalId) {
        if(!confirm('ì •ë§ ì°œ ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            const response = await fetch(`/api/favorite/${animalId}`, { method: 'POST' });
            const data = await response.json();
            
            if (data.action === 'removed') {
                alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.reload(); 
            } else {
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ì˜¤ë¥˜:', error);
            alert('ì„œë²„ í†µì‹  ì˜¤ë¥˜');
        }
    }

    // 2. ìƒì„¸ íŒì—… ì—´ê¸° í•¨ìˆ˜
    async function openDetailModal(id) {
      try {
        const response = await fetch(`/api/animal/${id}`);
        const data = await response.json();
        
        document.getElementById('m_breed').innerText = data.breed || 'í’ˆì¢… ì •ë³´ ì—†ìŒ';
        document.getElementById('m_gender').innerText = data.gender || '-';
        document.getElementById('m_weight').innerText = data.weight || '-';
        document.getElementById('m_years').innerText = data.years || '-';
        document.getElementById('m_region').innerText = data.region || '-';
        document.getElementById('m_sdate').innerText = data.register_date || '-';
        document.getElementById('m_edate').innerText = data.register_end_date || '-';
        document.getElementById('m_shelter').innerText = data.shelter_name || '-';

        currentShelterPhone = data.shelter_phone || 'ë²ˆí˜¸ ì •ë³´ ì—†ìŒ';

        const imgEl = document.getElementById('m_image');
        const emojiEl = document.getElementById('m_emoji');
        
        if (data.image_url && data.image_url.trim() !== "") {
            imgEl.src = data.image_url;
            imgEl.style.display = 'block';
            emojiEl.style.display = 'none';
        } else {
            imgEl.style.display = 'none';
            emojiEl.style.display = 'block';
        }
        
        document.getElementById('animalModal').classList.add('active');
      } catch (error) { 
        console.error('ì‹¤íŒ¨:', error);
        alert('ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    //3. ì…ì–‘ ë¬¸ì˜ ì „í™” í•¨ìˆ˜
    async function contactShelter() {
        if (currentShelterPhone && currentShelterPhone !== 'ë²ˆí˜¸ ì •ë³´ ì—†ìŒ') {
            try {
                await navigator.clipboard.writeText(currentShelterPhone);
                if(confirm(`ğŸ“‹ ì „í™”ë²ˆí˜¸ [ ${currentShelterPhone} ]ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n(PCì—ì„œëŠ” Ctrl+Vë¡œ ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥)\n\nì§€ê¸ˆ ì „í™”ë¥¼ ê±°ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    window.location.href = `tel:${currentShelterPhone}`;
                }
            } catch (err) {
                if(confirm(`ğŸ“ ë³´í˜¸ì†Œ ì „í™”ë²ˆí˜¸ëŠ” [ ${currentShelterPhone} ] ì…ë‹ˆë‹¤.\n\nì§€ê¸ˆ ì „í™”ë¥¼ ê±°ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    window.location.href = `tel:${currentShelterPhone}`;
                }
            }
        } else {
            alert("ì£„ì†¡í•©ë‹ˆë‹¤. ì´ ë³´í˜¸ì†ŒëŠ” ì „í™”ë²ˆí˜¸ ì •ë³´ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        }
    }

    function closeModalButton() { document.getElementById('animalModal').classList.remove('active'); }
    function closeModal(event) { if (event.target === document.getElementById('animalModal')) closeModalButton(); }
  </script>
</body>
</html>