<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PetMatch - ìœ ê¸°ë™ë¬¼ ëª©ë¡</title>
  <link rel="stylesheet" href="{{ url_for('serve_css') }}" />
  <style>
    .btn.liked { color: red; border-color: red; background: #fff5f5; }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand"><a href="/" style="text-decoration:none; color:inherit;">ğŸ¾ PetMatch</a></div>
    <nav class="nav">
      <a href="/animals">ìœ ê¸°ë™ë¬¼</a>
      <a href="/shelter">ë³´í˜¸ì†Œ</a>
      <a href="/hospital">ë³‘ì›/ì•½êµ­</a>
      
      {% if session['user_id'] %}
        <span style="font-size:14px; font-weight:bold; margin-right:4px;">{{ session['user_name'] }}ë‹˜</span>
        
        {% if session.get('is_admin') == 1 %}
          <a class="btn primary" href="/admin" style="padding: 6px 12px; font-size: 13px;">ê´€ë¦¬ì</a>
        {% else %}
          <a href="/mypage" style="font-weight:bold; color:var(--accent);">ë§ˆì´í˜ì´ì§€</a>
        {% endif %}

        <a class="btn ghost" href="/logout">ë¡œê·¸ì•„ì›ƒ</a>
      {% else %}
        <a class="btn ghost" href="/login">ë¡œê·¸ì¸</a>
      {% endif %}
    </nav>
  </header>

  <main class="container">
    <section class="hero" style="margin-bottom:16px;">
      <h1 style="margin-bottom:8px;">ìœ ê¸°ë™ë¬¼ ëª©ë¡</h1>
      <p style="margin-bottom:14px;">ì¡°ê±´ì„ ê³¨ë¼ì„œ ê³µê³ ë¥¼ ë¹ ë¥´ê²Œ ì°¾ì•„ë³´ì„¸ìš”.</p>
      
      <div class="searchbar">
        <input id="searchInput" placeholder="í’ˆì¢…, ì§€ì—­, ë³´í˜¸ì†Œëª… ê²€ìƒ‰" value="{{ curr_keyword }}" onkeypress="handleEnter(event)"/>
        <button class="btn primary" onclick="applyFilters()">ê²€ìƒ‰</button>
      </div>

      <div class="chips">
        <button class="chip" onclick="quickFilter('species', 'ê°œ')">ê°•ì•„ì§€</button>
        <button class="chip" onclick="quickFilter('species', 'ê³ ì–‘ì´')">ê³ ì–‘ì´</button>
        <button class="chip" onclick="quickFilter('gender', 'ìˆ˜ì»·')">ìˆ˜ì»·</button>
        <button class="chip" onclick="quickFilter('gender', 'ì•”ì»·')">ì•”ì»·</button>
      </div>
    </section>

    <section class="layout">
      <aside class="filters">
        <h2>í•„í„°</h2>
        <label class="field">
          <span>ì§€ì—­</span>
          <select id="regionFilter">
            <option value="ì „ì²´">ì „ì²´</option>
            {% for area in region_list %}
              <option value="{{ area }}" {% if curr_region == area %}selected{% endif %}>
                {{ area }}
              </option>
            {% endfor %}
          </select>
        </label>
        <label class="field"><span>ë™ë¬¼ì¢…</span><select id="speciesFilter"><option value="ì „ì²´">ì „ì²´</option><option {% if curr_species=='ê°œ' %}selected{% endif %}>ê°œ</option><option {% if curr_species=='ê³ ì–‘ì´' %}selected{% endif %}>ê³ ì–‘ì´</option></select></label>
        <label class="field"><span>ì„±ë³„</span><select id="genderFilter"><option value="ì „ì²´">ì „ì²´</option><option {% if curr_gender=='ìˆ˜ì»·' %}selected{% endif %}>ìˆ˜ì»·</option><option {% if curr_gender=='ì•”ì»·' %}selected{% endif %}>ì•”ì»·</option></select></label>
        <button class="btn primary full" style="margin-top:6px;" onclick="applyFilters()">ì ìš©</button>
        <button class="btn ghost full" style="margin-top:8px;" onclick="location.href='/animals'">ì´ˆê¸°í™”</button>
      </aside>

      <section class="results">
        <div class="results-head">
          <div>ê²°ê³¼ <b>{{ animals|length }}</b>ê±´</div>
          <select id="sortFilter" onchange="applyFilters()" style="padding:5px; border-radius:6px; border:1px solid #ddd;">
            <option value="newest" {% if curr_sort == 'newest' %}selected{% endif %}>ìµœì‹ ìˆœ</option>
            <option value="oldest" {% if curr_sort == 'oldest' %}selected{% endif %}>ì˜¤ë˜ëœìˆœ</option>
          </select>
        </div>

        <div class="grid">
          {% if animals %}
            {% for animal in animals %}
            <article class="card">
              <div class="thumb" style="background-color: #eee; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                {% if animal['image_url'] %}
                  <img src="{{ animal['image_url'] }}" alt="{{ animal['breed'] }}" style="width:100%; height:100%; object-fit:cover;">
                {% else %}
                  <span style="font-size:30px;">ğŸ•</span>
                {% endif %}
              </div>
              <div class="card-body">
                <div class="title">{{ animal['breed'] }}</div>
                <div class="meta">{{ animal['gender'] }} Â· {{ animal['weight'] }}</div>
                <div class="meta">ì§€ì—­: {{ animal['region'] }}</div>
                <div class="meta">ë³´í˜¸ì†Œ: {{ animal['shelter_name'] }}</div>
                <div class="actions">
                  <button class="btn primary" onclick="openDetailModal({{ animal['animal_id'] }})">ìƒì„¸</button>
                  
                  <button class="btn ghost {% if animal['animal_id'] in fav_ids %}liked{% endif %}" 
                          id="btn-fav-{{ animal['animal_id'] }}"
                          onclick="toggleFavorite({{ animal['animal_id'] }})">
                    {% if animal['animal_id'] in fav_ids %}â™¥{% else %}â™¡{% endif %} ê´€ì‹¬
                  </button>

                </div>
              </div>
            </article>
            {% endfor %}
          {% else %}
            <p style="padding:20px;">ì¡°ê±´ì— ë§ëŠ” ì¹œêµ¬ê°€ ì—†ì–´ìš”.</p>
          {% endif %}
        </div>
      </section>
    </section>
  </main>

  <div id="animalModal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-window">
      <button class="modal-close" onclick="closeModalButton()">Ã—</button>
      <div class="modal-image-area">
          <img id="m_image" src="" alt="" />
          <span id="m_emoji" style="font-size:50px; display:none;">ğŸ•</span>
      </div>
      <div class="modal-content">
        <div class="modal-tag" id="m_status">ë³´í˜¸ì¤‘</div>
        <h2 id="m_breed"></h2>
        <div class="modal-info-row"><div class="modal-label">íŠ¹ì§•</div><div class="modal-value"><span id="m_gender"></span> / <span id="m_weight"></span></div></div>
        <div class="modal-info-row"><div class="modal-label">ë‚˜ì´</div><div class="modal-value" id="m_years"></div></div>
        <div class="modal-info-row"><div class="modal-label">ë°œê²¬ì¥ì†Œ</div><div class="modal-value" id="m_region"></div></div>
        <div class="modal-info-row"><div class="modal-label">ê³µê³ ê¸°ê°„</div><div class="modal-value"><span id="m_sdate"></span> ~ <span id="m_edate"></span></div></div>
        <hr style="border:0; border-top:1px dashed #ddd; margin:15px 0;">
        <div class="modal-info-row"><div class="modal-label">ë³´í˜¸ì†Œ</div><div class="modal-value" id="m_shelter"></div></div>
        <div class="actions" style="margin-top:20px;">
            <button class="btn primary full" onclick="contactShelter()">ğŸ“ ì…ì–‘ ë¬¸ì˜í•˜ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentShelterPhone = '';

    // ì¢‹ì•„ìš” í† ê¸€ í•¨ìˆ˜
    async function toggleFavorite(animalId) {
        try {
            const response = await fetch(`/api/favorite/${animalId}`, { method: 'POST' });
            
            // ë¡œê·¸ì¸ ì•ˆ í–ˆì„ ë•Œ
            if (response.status === 401) {
                if(confirm('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í• ê¹Œìš”?')) {
                    window.location.href = '/login';
                }
                return;
            }
            
            const data = await response.json();
            
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë° ì•„ì´ì½˜ ë³€ê²½
            const btn = document.getElementById(`btn-fav-${animalId}`);
            if (data.action === 'added') {
                btn.classList.add('liked');
                btn.innerHTML = 'â™¥ ê´€ì‹¬';
            } else {
                btn.classList.remove('liked');
                btn.innerHTML = 'â™¡ ê´€ì‹¬';
            }
        } catch (error) {
            console.error('ì¢‹ì•„ìš” ì²˜ë¦¬ ì‹¤íŒ¨:', error);
            alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    function applyFilters() {
        const keyword = document.getElementById('searchInput').value;
        const region = document.getElementById('regionFilter').value;
        const species = document.getElementById('speciesFilter').value;
        const gender = document.getElementById('genderFilter').value;
        const sort = document.getElementById('sortFilter').value;

        let url = `/animals?keyword=${encodeURIComponent(keyword)}`;
        if(region !== 'ì „ì²´') url += `&region=${encodeURIComponent(region)}`;
        if(species !== 'ì „ì²´') url += `&species=${encodeURIComponent(species)}`;
        if(gender !== 'ì „ì²´') url += `&gender=${encodeURIComponent(gender)}`;
        url += `&sort=${encodeURIComponent(sort)}`;
        window.location.href = url;
    }

    function quickFilter(key, value) {
        let url = `/animals?${key}=${encodeURIComponent(value)}`;
        window.location.href = url;
    }

    function handleEnter(e) { if(e.key === 'Enter') applyFilters(); }

    async function openDetailModal(id) {
      try {
        const response = await fetch(`/api/animal/${id}`);
        const data = await response.json();
        
        document.getElementById('m_breed').innerText = data.breed || 'í’ˆì¢… ì •ë³´ ì—†ìŒ';
        document.getElementById('m_gender').innerText = data.gender || '-';
        document.getElementById('m_weight').innerText = data.weight || '-';
        document.getElementById('m_years').innerText = data.years || '-';
        document.getElementById('m_region').innerText = data.region || '-';
        document.getElementById('m_sdate').innerText = data.register_date || '-';
        document.getElementById('m_edate').innerText = data.register_end_date || '-';
        document.getElementById('m_shelter').innerText = data.shelter_name || '-';

        currentShelterPhone = data.shelter_phone || 'ë²ˆí˜¸ ì •ë³´ ì—†ìŒ';

        const imgEl = document.getElementById('m_image');
        const emojiEl = document.getElementById('m_emoji');
        
        if (data.image_url && data.image_url.trim() !== "") {
            imgEl.src = data.image_url;
            imgEl.style.display = 'block';
            emojiEl.style.display = 'none';
        } else {
            imgEl.style.display = 'none';
            emojiEl.style.display = 'block';
        }
        
        document.getElementById('animalModal').classList.add('active');
      } catch (error) { 
        console.error('ì‹¤íŒ¨:', error);
        alert('ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    async function contactShelter() {
        if (currentShelterPhone && currentShelterPhone !== 'ë²ˆí˜¸ ì •ë³´ ì—†ìŒ') {
            try {
                await navigator.clipboard.writeText(currentShelterPhone);
                if(confirm(`ğŸ“‹ ì „í™”ë²ˆí˜¸ [ ${currentShelterPhone} ]ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n(PCì—ì„œëŠ” Ctrl+Vë¡œ ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥)\n\nì§€ê¸ˆ ì „í™”ë¥¼ ê±°ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    window.location.href = `tel:${currentShelterPhone}`;
                }
            } catch (err) {
                if(confirm(`ğŸ“ ë³´í˜¸ì†Œ ì „í™”ë²ˆí˜¸ëŠ” [ ${currentShelterPhone} ] ì…ë‹ˆë‹¤.\n\nì§€ê¸ˆ ì „í™”ë¥¼ ê±°ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    window.location.href = `tel:${currentShelterPhone}`;
                }
            }
        } else {
            alert("ì£„ì†¡í•©ë‹ˆë‹¤. ì´ ë³´í˜¸ì†ŒëŠ” ì „í™”ë²ˆí˜¸ ì •ë³´ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        }
    }

    function closeModalButton() { document.getElementById('animalModal').classList.remove('active'); }
    function closeModal(event) { if (event.target === document.getElementById('animalModal')) closeModalButton(); }
  </script>
</body>
</html>