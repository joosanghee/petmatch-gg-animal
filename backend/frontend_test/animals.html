<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PetMatch - ìœ ê¸°ë™ë¬¼ ëª©ë¡</title>
  <link rel="stylesheet" href="{{ url_for('serve_css') }}" />
  <style>
    /* ê½‰ ì°¬ í•˜íŠ¸ ìŠ¤íƒ€ì¼ */
    .btn.liked { color: red; border-color: red; background: #fff5f5; }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand"><a href="/" style="text-decoration:none; color:inherit;">ğŸ¾ PetMatch</a></div>
    <nav class="nav">
      <a href="/animals">ìœ ê¸°ë™ë¬¼</a>
      <a href="/shelter">ë³´í˜¸ì†Œ</a>
      <a href="/hospital">ë³‘ì›/ì•½êµ­</a>
      
      {% if session['user_id'] %}
        <a href="/mypage" style="font-weight:bold; color:var(--accent);">ë§ˆì´í˜ì´ì§€</a>
        <a class="btn ghost" href="/logout">ë¡œê·¸ì•„ì›ƒ</a>
      {% else %}
        <a class="btn ghost" href="/login">ë¡œê·¸ì¸</a>
      {% endif %}
    </nav>
  </header>

  <main class="container">
    <section class="hero" style="margin-bottom:16px;">
      <h1 style="margin-bottom:8px;">ìœ ê¸°ë™ë¬¼ ëª©ë¡</h1>
      <p style="margin-bottom:14px;">ì¡°ê±´ì„ ê³¨ë¼ì„œ ê³µê³ ë¥¼ ë¹ ë¥´ê²Œ ì°¾ì•„ë³´ì„¸ìš”.</p>
      
      <div class="searchbar">
        <input id="searchInput" placeholder="í’ˆì¢…, ì§€ì—­, ë³´í˜¸ì†Œëª… ê²€ìƒ‰" value="{{ curr_keyword }}" onkeypress="handleEnter(event)"/>
        <button class="btn primary" onclick="applyFilters()">ê²€ìƒ‰</button>
      </div>

      <div class="chips">
        <button class="chip" onclick="quickFilter('species', 'ê°œ')">ê°•ì•„ì§€</button>
        <button class="chip" onclick="quickFilter('species', 'ê³ ì–‘ì´')">ê³ ì–‘ì´</button>
        <button class="chip" onclick="quickFilter('gender', 'ìˆ˜ì»·')">ìˆ˜ì»·</button>
        <button class="chip" onclick="quickFilter('gender', 'ì•”ì»·')">ì•”ì»·</button>
      </div>
    </section>

    <section class="layout">
      <aside class="filters">
        <h2>í•„í„°</h2>
        <label class="field">
          <span>ì§€ì—­</span>
          <select id="regionFilter">
            <option value="ì „ì²´">ì „ì²´</option>
            
            {% for area in region_list %}
              <option value="{{ area }}" {% if curr_region == area %}selected{% endif %}>
                {{ area }}
              </option>
            {% endfor %}
            
          </select>
        </label>
        <label class="field"><span>ë™ë¬¼ì¢…</span><select id="speciesFilter"><option value="ì „ì²´">ì „ì²´</option><option {% if curr_species=='ê°œ' %}selected{% endif %}>ê°œ</option><option {% if curr_species=='ê³ ì–‘ì´' %}selected{% endif %}>ê³ ì–‘ì´</option></select></label>
        <label class="field"><span>ì„±ë³„</span><select id="genderFilter"><option value="ì „ì²´">ì „ì²´</option><option {% if curr_gender=='ìˆ˜ì»·' %}selected{% endif %}>ìˆ˜ì»·</option><option {% if curr_gender=='ì•”ì»·' %}selected{% endif %}>ì•”ì»·</option></select></label>
        <button class="btn primary full" style="margin-top:6px;" onclick="applyFilters()">ì ìš©</button>
        <button class="btn ghost full" style="margin-top:8px;" onclick="location.href='/animals'">ì´ˆê¸°í™”</button>
      </aside>

      <section class="results">
        <div class="results-head">
          <div>ê²°ê³¼ <b>{{ animals|length }}</b>ê±´</div>
          <select id="sortFilter" onchange="applyFilters()" style="padding:5px; border-radius:6px; border:1px solid #ddd;">
            <option value="newest" {% if curr_sort == 'newest' %}selected{% endif %}>ìµœì‹ ìˆœ</option>
            <option value="oldest" {% if curr_sort == 'oldest' %}selected{% endif %}>ì˜¤ë˜ëœìˆœ</option>
          </select>
        </div>

        <div class="grid">
          {% if animals %}
            {% for animal in animals %}
            <article class="card">
              <div class="thumb" style="background-color: #eee; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                {% if animal['image_url'] %}
                  <img src="{{ animal['image_url'] }}" alt="{{ animal['breed'] }}" style="width:100%; height:100%; object-fit:cover;">
                {% else %}
                  <span style="font-size:30px;">ğŸ•</span>
                {% endif %}
              </div>
              <div class="card-body">
                <div class="title">{{ animal['breed'] }}</div>
                <div class="meta">{{ animal['gender'] }} Â· {{ animal['weight'] }}</div>
                <div class="meta">ì§€ì—­: {{ animal['region'] }}</div>
                <div class="meta">ë³´í˜¸ì†Œ: {{ animal['shelter_name'] }}</div>
                <div class="actions">
                  <button class="btn primary" onclick="openDetailModal({{ animal['animal_id'] }})">ìƒì„¸</button>
                  
                  <button class="btn ghost {% if animal['animal_id'] in fav_ids %}liked{% endif %}" 
                          id="btn-fav-{{ animal['animal_id'] }}"
                          onclick="toggleFavorite({{ animal['animal_id'] }})">
                    {% if animal['animal_id'] in fav_ids %}â™¥{% else %}â™¡{% endif %} ê´€ì‹¬
                  </button>

                </div>
              </div>
            </article>
            {% endfor %}
          {% else %}
            <p style="padding:20px;">ì¡°ê±´ì— ë§ëŠ” ì¹œêµ¬ê°€ ì—†ì–´ìš”.</p>
          {% endif %}
        </div>
      </section>
    </section>
  </main>

  <div id="animalModal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-window">
      <button class="modal-close" onclick="closeModalButton()">Ã—</button>
      <div class="modal-image-area"><img id="m_image" src="" alt="" /><span id="m_emoji" style="font-size:50px;">ğŸ•</span></div>
      <div class="modal-content">
        <div class="modal-tag" id="m_status">ë³´í˜¸ì¤‘</div>
        <h2 id="m_breed"></h2>
        <div class="modal-info-row"><div class="modal-label">íŠ¹ì§•</div><div class="modal-value"><span id="m_gender"></span> / <span id="m_weight"></span></div></div>
        <div class="modal-info-row"><div class="modal-label">ë°œê²¬ì¥ì†Œ</div><div class="modal-value" id="m_region"></div></div>
        <div class="modal-info-row"><div class="modal-label">ê³µê³ ê¸°ê°„</div><div class="modal-value"><span id="m_sdate"></span> ~ <span id="m_edate"></span></div></div>
        <hr style="border:0; border-top:1px dashed #ddd; margin:15px 0;">
        <div class="modal-info-row"><div class="modal-label">ë³´í˜¸ì†Œ</div><div class="modal-value" id="m_shelter"></div></div>
        <div class="actions" style="margin-top:20px;">
            <button class="btn primary full" onclick="alert('ì…ì–‘ ë¬¸ì˜ ì „í™”ë¥¼ ê²ë‹ˆë‹¤.')">ğŸ“ ì…ì–‘ ë¬¸ì˜í•˜ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    //  ì¢‹ì•„ìš” í† ê¸€ í•¨ìˆ˜
    async function toggleFavorite(animalId) {
        try {
            const response = await fetch(`/api/favorite/${animalId}`, { method: 'POST' });
            if (response.status === 401) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤!');
                window.location.href = '/login';
                return;
            }
            const data = await response.json();
            
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³€ê²½
            const btn = document.getElementById(`btn-fav-${animalId}`);
            if (data.action === 'added') {
                btn.classList.add('liked');
                btn.innerHTML = 'â™¥ ê´€ì‹¬';
            } else {
                btn.classList.remove('liked');
                btn.innerHTML = 'â™¡ ê´€ì‹¬';
            }
        } catch (error) {
            console.error('ì¢‹ì•„ìš” ì²˜ë¦¬ ì‹¤íŒ¨:', error);
        }
    }

    //í•„í„°/ê²€ìƒ‰/ëª¨ë‹¬ ìŠ¤í¬ë¦½íŠ¸
    function applyFilters() {
        const keyword = document.getElementById('searchInput').value;
        const region = document.getElementById('regionFilter').value;
        const species = document.getElementById('speciesFilter').value;
        const gender = document.getElementById('genderFilter').value;
        const sort = document.getElementById('sortFilter').value;

        let url = `/animals?keyword=${encodeURIComponent(keyword)}`;
        if(region !== 'ì „ì²´') url += `&region=${encodeURIComponent(region)}`;
        if(species !== 'ì „ì²´') url += `&species=${encodeURIComponent(species)}`;
        if(gender !== 'ì „ì²´') url += `&gender=${encodeURIComponent(gender)}`;
        url += `&sort=${encodeURIComponent(sort)}`;
        
        window.location.href = url;
    }
    function quickFilter(k, v) { window.location.href = `/animals?${k}=${encodeURIComponent(v)}`; }
    function handleEnter(e) { if(e.key === 'Enter') applyFilters(); }
    
    async function openDetailModal(id) {
      const response = await fetch(`/api/animal/${id}`);
      const data = await response.json();
      document.getElementById('m_breed').innerText = data.breed;
      document.getElementById('m_gender').innerText = data.gender;
      document.getElementById('m_weight').innerText = data.weight;
      document.getElementById('m_region').innerText = data.region;
      document.getElementById('m_sdate').innerText = data.register_date;
      document.getElementById('m_edate').innerText = data.register_end_date;
      document.getElementById('m_shelter').innerText = data.shelter_name;
      const imgEl = document.getElementById('m_image');
      if (data.image_url) { imgEl.src = data.image_url; imgEl.style.display='block'; document.getElementById('m_emoji').style.display='none'; }
      else { imgEl.style.display='none'; document.getElementById('m_emoji').style.display='block'; }
      document.getElementById('animalModal').classList.add('active');
    }
    function closeModalButton() { document.getElementById('animalModal').classList.remove('active'); }
    function closeModal(e) { if (e.target === document.getElementById('animalModal')) closeModalButton(); }
  </script> 
</body>
</html>